# Prompt Engineering STRESS TEST - Differentiate Prompt Strategies
# Compare Minimal vs Standard vs Chain-of-Thought prompts
# Uses: Noisy haystack, semantic distractors, contradictory info, multi-step reasoning
# Matrix: 3 prompts × 2 models × 10 tests = 60 evaluations

description: "Prompt engineering STRESS TEST - hard cases to differentiate prompts"

providers:
  # GPT-4o-mini
  - id: openai:gpt-4o-mini
    label: "GPT-4o-mini"
    config:
      temperature: 0.1

  # Claude Haiku 4.5
  - id: anthropic:messages:claude-haiku-4-5-20251001
    label: "Claude Haiku 4.5"
    config:
      temperature: 0.1

prompts:
  # Prompt 1: Minimal - baseline with no instructions
  - id: file://../../../prompts/experiments/minimal_prompt.txt
    label: "Minimal"

  # Prompt 2: Standard - production-style with explicit constraints
  - id: file://../../../prompts/experiments/standard_prompt.txt
    label: "Standard"

  # Prompt 3: Chain-of-Thought - step-by-step reasoning
  - id: file://../../../prompts/experiments/cot_prompt.txt
    label: "Chain-of-Thought"

# Default assertions applied to ALL test cases
defaultTest:
  assert:
    # Latency threshold: 15 seconds for generation (CoT may be slower)
    - type: latency
      threshold: 15000
      weight: 1

tests:
  # =============================================================================
  # CATEGORY 1: NOISY HAYSTACK (3 tests)
  # Add distractor data from similar quarters/companies to confuse the model
  # =============================================================================

  # Test 1.1: Needle buried in similar data - 5 similar numbers, only 1 correct
  - description: "STRESS - Needle in haystack: iPhone revenue among 5 quarters"
    vars:
      query: "What was Apple's iPhone revenue for Q3 2023?"
      context: |
        [Source: 2023 Q2 AAPL.pdf]
        iPhone net sales Q2 2023: $42,626 million

        [Source: 2022 Q3 AAPL.pdf]
        iPhone net sales Q3 2022: $40,665 million

        [Source: 2023 Q3 AAPL.pdf]
        iPhone net sales Q3 2023: $39,669 million

        [Source: 2023 Q4 AAPL.pdf]
        iPhone net sales Q4 2023: $43,805 million

        [Source: Analyst estimates - NOT OFFICIAL]
        Projected iPhone sales Q1 2024: $45,000 million (estimated)
      ground_truth: "$39,669 million for Q3 2023"
    assert:
      # Must have correct answer
      - type: javascript
        value: "output.includes('39,669') || output.includes('39669')"
        weight: 4
      # Must NOT grab Q2 distractor
      - type: not-icontains
        value: "42,626"
        weight: 3
      # Must NOT grab Q4 distractor
      - type: not-icontains
        value: "43,805"
        weight: 3
      # Must NOT grab estimate
      - type: not-icontains
        value: "45,000"
        weight: 2

  # Test 1.2: Answer lost in the middle of long context
  - description: "STRESS - Lost in middle: NVIDIA gross profit buried in noise"
    vars:
      query: "What was NVIDIA's gross profit for Q3 FY2024?"
      context: |
        SEMICONDUCTOR INDUSTRY QUARTERLY REVIEW - Q3 2023

        The global semiconductor market experienced significant volatility during the third
        quarter of 2023. Multiple factors contributed to shifting dynamics across the industry,
        including supply chain adjustments, changing demand patterns in consumer electronics,
        and the rapid acceleration of artificial intelligence applications.

        Intel Corporation reported challenging results as the company continues its turnaround
        efforts under CEO Pat Gelsinger. The company's foundry services division showed early
        signs of customer traction, though volumes remain modest compared to established players.
        AMD continued to gain market share in data center CPUs, with EPYC processors seeing
        strong adoption among cloud service providers.

        Market analysts have noted the diverging fortunes of companies in the AI accelerator
        space. While some traditional chip makers struggle to compete, others have positioned
        themselves advantageously for the generative AI boom. Memory makers including Samsung,
        SK Hynix, and Micron have benefited from increased demand for high-bandwidth memory
        used in AI training systems.

        NVIDIA Q3 FY2024 Financial Results:
        Revenue: $18,120 million
        Cost of revenue: $5,078 million
        Gross profit: $13,042 million

        Looking ahead, the industry faces both opportunities and challenges. The continued
        buildout of AI infrastructure is expected to drive demand through 2024 and beyond.
        However, geopolitical tensions, particularly around export restrictions to China,
        create uncertainty for companies with significant exposure to that market.

        Inventory levels across the industry have normalized following the pandemic-era
        shortages. Most companies report healthy channel inventory, though some segments
        like automotive continue to see elevated lead times.

        Disclaimer: This report contains forward-looking statements. Actual results may
        differ materially from projections. Past performance is not indicative of future
        results. Investors should conduct their own due diligence.
      ground_truth: "$13,042 million"
    assert:
      - type: javascript
        value: "output.includes('13,042') || output.includes('13042') || output.includes('13.0')"
        weight: 4
      # Should NOT grab Intel data
      - type: not-icontains
        value: "Intel"
        weight: 2
      # Should cite NVIDIA
      - type: icontains
        value: "NVIDIA"
        weight: 2

  # Test 1.3: Ambiguous query - multiple companies match the date criteria
  - description: "STRESS - Ambiguous query: multiple companies with Sep 30 quarter end"
    vars:
      query: "What was the operating income for the company that reported Q3 2023 results ending September 30?"
      context: |
        [Source: 2023 Q3 NVDA.pdf - Quarter ended October 29, 2023]
        NVIDIA Corporation
        Operating income: $10,059 million

        [Source: 2023 Q3 AAPL.pdf - Quarter ended July 1, 2023]
        Apple Inc.
        Operating income: $23,993 million

        [Source: 2023 Q3 MSFT.pdf - Quarter ended September 30, 2023]
        Microsoft Corporation
        Operating income: $26,078 million

        [Source: 2023 Q3 INTC.pdf - Quarter ended September 30, 2023]
        Intel Corporation
        Operating income: $536 million
      ground_truth: "Microsoft: $26,078 million OR Intel: $536 million - both companies had quarters ending September 30"
    assert:
      # Must mention at least one correct company
      - type: javascript
        value: "output.includes('26,078') || output.includes('536')"
        weight: 3
      # Should NOT claim NVIDIA (wrong date)
      - type: not-icontains
        value: "October 29"
        weight: 2
      # Should recognize ambiguity OR pick one correctly
      - type: llm-rubric
        value: |
          Two companies (Microsoft and Intel) had quarters ending September 30, 2023.
          The model should either:
          1. Recognize the ambiguity and mention both, OR
          2. Pick one and provide the correct figure

          Score 1.0 if mentions both companies or correctly identifies one with right figure.
          Score 0.5 if picks one company correctly.
          Score 0 if provides wrong company's data (NVIDIA or Apple).
        threshold: 0.6
        weight: 3

  # =============================================================================
  # CATEGORY 2: SEMANTIC DISTRACTORS (2 tests)
  # Similar-looking metrics that are NOT the correct answer
  # =============================================================================

  # Test 2.1: Many margin metrics - must pick the right one
  - description: "STRESS - Semantic distractor: gross margin among 7 margin metrics"
    vars:
      query: "What was Apple's gross margin for Q3 2023?"
      context: |
        [Source: 2023 Q3 AAPL.pdf]
        Apple Inc. - Financial Highlights Q3 2023

        Revenue Metrics:
        - Net sales: $81,797 million

        Margin Analysis:
        - Gross margin: $36,413 million
        - Gross margin percentage: 44.5%
        - Operating margin: $23,993 million
        - Operating margin percentage: 29.3%
        - Net income margin percentage: 25.3%

        Segment Margins:
        - Products gross margin percentage: 35.4%
        - Services gross margin percentage: 70.5%

        Note: "Gross margin" refers to the company-wide figure unless otherwise specified.
      ground_truth: "$36,413 million or 44.5%"
    assert:
      # Must have gross margin (dollar or percentage)
      - type: javascript
        value: "output.includes('36,413') || output.includes('36413') || output.includes('44.5')"
        weight: 4
      # Should NOT give operating margin
      - type: not-icontains
        value: "23,993"
        weight: 3
      # Should NOT give segment-specific margins as THE answer
      - type: llm-rubric
        value: |
          The question asks for "gross margin" - the company-wide figure.
          Correct answers: $36,413 million OR 44.5%

          WRONG answers that are distractors:
          - Operating margin: $23,993 million or 29.3%
          - Products gross margin: 35.4%
          - Services gross margin: 70.5%

          Score 1.0 if gives $36,413 million or 44.5% as the main answer.
          Score 0.5 if mentions correct figure but also includes distractors.
          Score 0 if gives operating margin or segment margins as THE answer.
        threshold: 0.7
        weight: 3

  # Test 2.2: Multiple growth rates - must match segment AND timeframe
  - description: "STRESS - Semantic distractor: YoY growth among 5 growth rates"
    vars:
      query: "By what percentage did NVIDIA's Data Center revenue grow year-over-year in Q3 FY2024?"
      context: |
        [Source: 2023 Q3 NVDA.pdf]
        NVIDIA Corporation - Revenue Performance Analysis

        Data Center Segment:
        - Q3 FY2024 revenue: $14,514 million
        - Q3 FY2023 revenue: $3,833 million
        - Year-over-year growth: 279%
        - Sequential growth (vs Q2 FY2024): 41%
        - Two-year CAGR: 89%

        Gaming Segment:
        - Year-over-year growth: 81%

        Total Company:
        - Year-over-year revenue growth: 206%
      ground_truth: "279% year-over-year growth for Data Center segment"
    assert:
      # Must have correct percentage
      - type: icontains
        value: "279"
        weight: 4
      # Should NOT give sequential growth
      - type: not-icontains
        value: "41%"
        weight: 3
      # Should NOT give Gaming segment
      - type: not-icontains
        value: "81%"
        weight: 3
      # Should NOT give total company
      - type: not-icontains
        value: "206%"
        weight: 2

  # =============================================================================
  # CATEGORY 3: CONTRADICTORY INFORMATION (2 tests)
  # Conflicting data that model must resolve
  # =============================================================================

  # Test 3.1: Multiple conflicting sources
  - description: "STRESS - Contradictory: cloud growth from 4 different sources"
    vars:
      query: "What was Microsoft's cloud revenue growth rate in Q3 2023?"
      context: |
        [Source: 2023 Q3 MSFT.pdf - Official SEC Filing]
        Intelligent Cloud segment revenue increased 19% year-over-year.
        Azure and other cloud services revenue grew 29%.

        [Source: Analyst Report - Morgan Stanley]
        Microsoft cloud business grew approximately 24% according to our analysis,
        driven by strong Azure adoption.

        [Source: Microsoft Press Release Summary]
        "Cloud revenue up over 20%" - Microsoft PR statement

        [Source: Industry Report - Gartner]
        Microsoft's cloud market share growth estimated at 15-18% YoY.

        Note: For financial reporting purposes, SEC filings are the authoritative source.
      ground_truth: "19% (Intelligent Cloud segment) or 29% (Azure specifically) from official SEC filing"
    assert:
      # Must cite official figure
      - type: javascript
        value: "output.includes('19') || output.includes('29')"
        weight: 4
      # Should NOT present analyst estimate as fact
      - type: not-icontains
        value: "24%"
        weight: 2
      # Should recognize SEC filing as authoritative
      - type: llm-rubric
        value: |
          Multiple sources provide different growth rates:
          - SEC Filing: 19% (Intelligent Cloud) or 29% (Azure)
          - Analyst: 24%
          - PR: "over 20%"
          - Gartner: 15-18%

          The model should prioritize the official SEC filing numbers.

          Score 1.0 if cites 19% or 29% AND mentions it's from official filing.
          Score 0.5 if gives 19% or 29% without source clarity.
          Score 0 if presents analyst estimate as the answer.
        threshold: 0.6
        weight: 3

  # Test 3.2: Corrected/restated figures
  - description: "STRESS - Contradictory: preliminary vs corrected figures"
    vars:
      query: "What was Intel's gross margin for Q3 2023?"
      context: |
        [Source: 2023 Q3 INTC.pdf - Original Filing dated October 26, 2023]
        Intel Corporation Q3 2023 Results (PRELIMINARY)
        Gross margin: $5,990 million

        [Source: 2023 Q3 INTC.pdf - Restated Filing dated November 15, 2023]
        Intel Corporation Q3 2023 Results (CORRECTED)
        Gross margin: $6,018 million

        Amendment Note: Original figures were restated due to accounting adjustment
        for inventory valuation. The corrected figure of $6,018 million reflects
        proper allocation of restructuring costs per ASC 420 guidance.

        The restated figures supersede all previously reported preliminary data.
      ground_truth: "$6,018 million (corrected/restated figure)"
    assert:
      # Must have corrected figure
      - type: icontains
        value: "6,018"
        weight: 4
      # Should NOT present preliminary as final
      - type: not-icontains
        value: "5,990"
        weight: 3
      # Should recognize restatement
      - type: llm-rubric
        value: |
          Two figures exist: $5,990M (preliminary) and $6,018M (corrected).
          The model should use the corrected/restated figure.

          Score 1.0 if gives $6,018 million and mentions it's the corrected figure.
          Score 0.5 if gives $6,018 million without context.
          Score 0 if gives $5,990 million (preliminary).
        threshold: 0.7
        weight: 3

  # =============================================================================
  # CATEGORY 4: MULTI-STEP REASONING (2 tests)
  # Require calculation, not just extraction
  # =============================================================================

  # Test 4.1: Calculate percentage change
  - description: "STRESS - Multi-step: calculate YoY percentage change"
    vars:
      query: "What was the percentage change in Apple's Services revenue from Q3 2022 to Q3 2023?"
      context: |
        [Source: 2022 Q3 AAPL.pdf]
        Apple Inc. - Three Months Ended June 25, 2022
        Services net sales: $19,604 million

        [Source: 2023 Q3 AAPL.pdf]
        Apple Inc. - Three Months Ended July 1, 2023
        Services net sales: $21,213 million

        Note: Year-over-year percentage change must be calculated from these figures.
        Formula: ((New - Old) / Old) × 100
      ground_truth: "Approximately 8.2% increase"
    assert:
      # Must calculate correctly (allow range 8-8.5%)
      - type: javascript
        value: "output.includes('8.2') || output.includes('8.1') || output.includes('8.3') || output.includes('8%')"
        weight: 4
      # Must indicate increase/growth
      - type: javascript
        value: "output.toLowerCase().includes('increase') || output.toLowerCase().includes('grew') || output.toLowerCase().includes('growth') || output.toLowerCase().includes('higher')"
        weight: 3
      # Should show work or mention calculation
      - type: llm-rubric
        value: |
          The model must calculate: (($21,213 - $19,604) / $19,604) × 100 = ~8.2%

          Score 1.0 if gives ~8.2% AND indicates it's an increase.
          Score 0.5 if calculation is close (8-9%) but reasoning unclear.
          Score 0 if just subtracts the numbers or gives wrong direction.
        threshold: 0.7
        weight: 3

  # Test 4.2: Compare and rank 4 companies
  - description: "STRESS - Multi-step: rank 4 companies by calculated gross margin %"
    vars:
      query: "Which company had the highest gross margin PERCENTAGE in their Q3 2023 reports? Rank all four."
      context: |
        [Source: 2023 Q3 AAPL.pdf]
        Apple Inc.
        Gross margin: $36,413 million
        Revenue: $81,797 million

        [Source: 2023 Q3 NVDA.pdf]
        NVIDIA Corporation
        Gross margin: $13,042 million
        Revenue: $18,120 million

        [Source: 2023 Q3 MSFT.pdf]
        Microsoft Corporation
        Gross margin: $40,215 million
        Revenue: $56,517 million

        [Source: 2023 Q3 INTC.pdf]
        Intel Corporation
        Gross margin: $6,018 million
        Revenue: $14,158 million

        Note: Calculate gross margin percentage as (Gross margin / Revenue) × 100
      ground_truth: "1. NVIDIA 72.0%, 2. Microsoft 71.2%, 3. Apple 44.5%, 4. Intel 42.5%"
    assert:
      # Must identify NVIDIA as highest
      - type: javascript
        value: "output.toLowerCase().includes('nvidia') && (output.includes('72') || output.includes('71') || output.includes('highest'))"
        weight: 4
      # Must identify Intel as lowest
      - type: javascript
        value: "output.toLowerCase().includes('intel') && (output.includes('42') || output.includes('43') || output.includes('lowest'))"
        weight: 3
      # Should rank all 4
      - type: llm-rubric
        value: |
          Correct calculations:
          - NVIDIA: 13,042/18,120 = 72.0% (highest)
          - Microsoft: 40,215/56,517 = 71.2%
          - Apple: 36,413/81,797 = 44.5%
          - Intel: 6,018/14,158 = 42.5% (lowest)

          Score 1.0 if correctly ranks all 4 with approximate percentages.
          Score 0.5 if gets top/bottom right but middle wrong.
          Score 0 if ranking is significantly wrong or no calculations shown.
        threshold: 0.6
        weight: 3

  # =============================================================================
  # CATEGORY 5: EDGE CASES (1 test)
  # Missing data that looks complete
  # =============================================================================

  # Test 5.1: Partial data - R&D not separately disclosed
  - description: "STRESS - Edge case: R&D percentage with missing breakdown"
    vars:
      query: "What was Apple's R&D spending as a percentage of revenue in Q3 2023?"
      context: |
        [Source: 2023 Q3 AAPL.pdf]
        Apple Inc. - Q3 2023 Financial Summary

        Total net sales: $81,797 million
        Cost of sales: $45,384 million
        Gross margin: $36,413 million

        Operating expenses: $13,420 million
        Operating income: $23,993 million

        Net income: $19,881 million
        Earnings per share: $1.26

        Note: Operating expenses include research and development, and selling,
        general and administrative expenses. Detailed breakdown of R&D spending
        is available in the full 10-Q filing and 10-K annual report.

        This summary does not separately disclose the R&D component.
      ground_truth: "R&D spending cannot be determined from this context - the breakdown is not provided"
    assert:
      # Should NOT fabricate a percentage
      - type: not-icontains
        value: "% of revenue"
        weight: 3
      # Should NOT calculate from operating expenses (that includes SG&A too)
      - type: not-icontains
        value: "16.4%"
        weight: 3
      # Should recognize missing data
      - type: llm-rubric
        value: |
          The context does NOT provide R&D spending separately - it only shows
          total "Operating expenses: $13,420 million" which includes both R&D and SG&A.

          The model should recognize that R&D cannot be determined from this context.

          Score 1.0 if clearly states R&D breakdown is not available.
          Score 0 if fabricates a specific R&D percentage or assumes operating expenses = R&D.
        threshold: 0.8
        weight: 4

evaluateOptions:
  maxConcurrency: 3
  cache: false  # Disable cache to ensure fresh evaluations

# Output configuration
outputPath: ./results/04_prompt_evaluation_{{timestamp}}.json
